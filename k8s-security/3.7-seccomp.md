<h2> Secure Computing Mode (Secomp) </h2>

## Seccomp
A Seccomp (Secure Computing Mode) profile is a security feature that restricts the system calls (syscalls) a process can make, thus limiting the potential attack surface of that process.

A JSON file specifying allowed and denied syscalls.

In the context of Docker and Kubernetes, seccomp profiles are used to enhance the security of containers by specifying which syscalls are permitted or denied.

A seccomp profile is a JSON file that defines a set of rules to restrict the system calls (syscalls) a process can make in a Linux environment. These profiles are used to enhance security by limiting the actions a process can perform, thereby reducing the attack surface. 

### Structure of a Seccomp Profile
A seccomp profile typically includes:

- defaultAction: The action to apply to syscalls not explicitly specified in the profile.
- syscalls: A list of syscall rules specifying which syscalls are allowed, denied, or handled in a specific way.

### Seccomp Profile with Various Actions
- SCMP_ACT_ALLOW: Allow the syscall.
- SCMP_ACT_ERRNO: Block the syscall and return an error.
- SCMP_ACT_TRAP: Block the syscall and send a `SIGSYS` signal.
- SCMP_ACT_KILL_PROCESS: Terminate the process.
- SCMP_ACT_LOG: Allow the syscall but log it.
- SCMP_ACT_TRACE: Notify a tracing process about the syscall.
- SCMP_ACT_NOTIFY: Notify a userspace handler about the syscall.
  
[Example of Seccomp Profile](https://kubernetes.io/docs/tutorials/security/seccomp/#download-profiles)

In Kubernetes, when defining a seccomp profile for a pod, the type field specifies the source or `type` of the seccomp profile. There are typically three options for the type field:

- Localhost: This indicates that the seccomp profile is stored locally on the node where the pod is scheduled. The profile is usually stored in a specific directory `/var/lib/kubelet/seccomp/profiles` on the node's filesystem.

- RuntimeDefault: This indicates that the container runtime (e.g., containerd, Docker) provides a default seccomp profile. The actual profile used depends on the container runtime and its configuration.

- Unconfined: This indicates that seccomp is disabled for the pod, allowing unrestricted access to syscalls. This is the default behavior if no seccomp profile is specified. When no seccompProfile is specified in a Kubernetes pod definition, the default behavior depends on the container runtime being used.

[Example of how Pod uses Seccomp Profile](https://kubernetes.io/docs/tutorials/security/seccomp/#create-a-pod-that-uses-the-container-runtime-default-seccomp-profile)


### Here are some seccomp profile related questions

Which of the following commands/tools can be used to trace syscalls ?\
`strace`

Which syscall is NOT made by the command ls /root?\
` strace -c ls /root` `Connect`This call is used for connecting network sockets - not required to list a local directory.


Observe the output captured by the tracee container.
Which was the last syscall that was generated by the container that ran the message echo hello?
`kubectl logs -n tracee -l app.kubernetes.io/name=tracee | grep hello | grep syscall | tail -n1`

What is the default Seccomp profile location in this cluster?\
`/var/lib/kubelet/seccomp/profiles/`

Create a new pod called audit-nginx using the nginx image and make use of the audit.json seccomp profile in the pod's security context. The audit.json file is already present in the default seccomp profile path in the controlplane node.

`ls -l /var/lib/kubelet/seccomp/profiles/`

Profile paths in manifests are specified relative to the default profile directory.
```bash
apiVersion: v1
kind: Pod
metadata:
  name: audit-nginx
  labels:
    app: audit-nginx
spec:
  securityContext:
    seccompProfile:
      type: Localhost
      localhostProfile: profiles/audit.json
  containers:
  - name: test-container
    image: nginx
    securityContext:
      allowPrivilegeEscalation: false
```
